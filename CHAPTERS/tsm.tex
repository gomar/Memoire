%!TEX root = ../main.tex
\chapter{Harmonic balance methods} % (fold)
\label{cha:harmonic_balance_methods}

The harmonic balance methods are now presented. 
We distinguish two cases: the case where the 
variables are assumed to be periodic in time and the one
where the variables are almost-periodic. This last can be defined as 
a variable that is composed of several frequencies which 
are not harmonically related. This is for example the case of 
$a=\pi$ and $b=1$. There is no integer $k$ that satisfies:
\begin{equation}
    a = k b.
\end{equation}
This leads to two methods, the time spectral method and the
harmonic balance method respectively.

In the following, we will consider the
the Unsteady Reynolds-Averaged Navier-Stokes (U-RANS) equations written in
integral form
\begin{equation}
   \int_\Omega \frac{\partial W}{\partial t} dV + \oint_{\partial
     \Omega} \overrightarrow{F} \cdot \overrightarrow{N} ds = 0,
   \label{eq:intNS}
\end{equation} 
where $\overrightarrow{F}$~is the flux across $\partial \Omega$ and
$W$~is the vector of the conservative unknowns (conservative variables
and turbulent variables).  Assuming $\Omega$ is a
control volume, the semi-discrete finite-volume form of the
U-RANS equations is obtained from Eq.~\eqref{eq:intNS}:
\begin{equation}
   \frac{d}{dt} \left(V  \overline{W}\right) + R \left( \overline{W}
   \right) = 0,
   \label{eq:semiDiscNS}
\end{equation} 
with $V$~the volume of the cell~$\Omega$, $R$~the residual resulting
from the discretization of the fluxes and the source terms (including
the turbulent equations), and $\overline{W}$ the mean of the
unknowns over the control volume.  In the following, the over line
symbol~$\overline{\cdot}$ is dropped out for clarity.

\section{Periodic flows} % (fold)
\label{sec:periodic_flows}

\subsection{Theory}

If the mean flow variables $W$~are periodic in time of period $T =
2\pi/\omega$, so are the residuals $R(W)$ and the Fourier series of
Eq.~\eqref{eq:semiDiscNS} is
\begin{equation}
  \label{eq:seriefour}
  \sum_{k=-\infty}^\infty \left(ik\omega
    V\widehat{W}_k+\widehat{R}_k\right)e^{ik\omega t}=0,
\end{equation}
where $\widehat{W}_k$ and $\widehat{R}_k$ are the Fourier coefficients
of $W$ and $R$ corresponding to the mode~$k$:
\begin{equation}
   W(t) = \sum_{k=-\infty}^{\infty} \widehat{W}_k e^{i k\omega t},\quad
   R(t) = \sum_{k=-\infty}^{\infty} \widehat{R}_k e^{i k\omega t}.
   \label{eq:fourierWsf}
\end{equation}
The complex exponential family forming an orthogonal basis, the only
way for Eq.~\eqref{eq:seriefour} to be true is that the weight of
every mode $k$ is zero, which leads to an infinite number of steady
equations in the frequency domain:
\begin{equation}
  \label{eq:orthodelim}
  ik\omega V\widehat{W}_k+\widehat{R}_k=0, \quad \quad \forall k \in
  \mathbb{Z}.
\end{equation}
McMullen~\emph{et al.}~\cite{McMullen2001,McMullen2002,McMullen2006}
solve a subset of these equations up to mode~$N$, $-N\leq k\leq N$,
yielding the Non-Linear Frequency Domain (NLFD) method.

The principle of the time-domain Harmonic Balance
approach~\cite{Hall2002}, sometimes referred to as Time Spectral
Method (TSM)~\cite{Gopinath2005, Sicot2008}, is to use an Inverse
Discrete Fourier Transform (IDFT) to cast back this subset of $2N+1$
frequency-domain equations into the time domain.  The IDFT then
induces linear relations between Fourier coefficients $\widehat{W}_k$
and a uniform sampling of $W$ at $2N+1$ instants in the period:
\begin{equation}
  W_n=\sum_{k=-N}^N\widehat{W}_k\exp(i\omega n\Delta t),\quad \quad 0 \leq n < 2N+1,
  \label{eq:hb_concatenation}
\end{equation}
with $W_n \equiv W(n \Delta t)$ and $\Delta t=T/(2N+1)$. This leads to
a new system of $2N+1$~mathematically steady equations coupled by a
source term:
\begin{equation}
  \label{eq:hbttime}
  R(W_n)+VD_t(W_n)=0, \quad \quad 0 \leq n < 2N+1.
\end{equation}
The source term $VD_t(W_n)$ appears as a high-order formulation of the
initial time derivative in Eq.~\eqref{eq:semiDiscNS}. This new time
operator connects all the time levels and can be expressed
analytically as
\begin{equation}
\label{eq:dt}
  D_t(W_n)=\sum_{m=-N}^{N} d_m W_{n+m},
\end{equation}
with
\begin{equation}
  d_m=
  \begin{cases}
    \frac{\pi}{T}(-1)^{m+1}\csc\left(\frac{\pi
        m}{2N+1}\right) &, \, m\neq 0,\\
    0 &, \, m=0.
  \end{cases}
\end{equation}
This equation clearly states that the source term is real for periodic flows.
A similar derivation can be made for an even number of instants, but
it is proved in Ref.~\cite{Weide2005} that it can lead to a numerically unstable odd-even
decoupling.

A pseudo-time ($\tau_n$) derivative is added to
Eqs.~\eqref{eq:hbttime} to march the equations in pseudo-time to the
steady-state solutions of all the instants:
\begin{equation}
  \label{eq:pseudohbttime}
  V\frac{\partial W_n}{\partial\tau_n} + R(W_n)+VD_t(W_n)=0, \quad \quad
  0 \leq n < 2N+1.
\end{equation}
This time step is defined locally in a given cell and can
  be different for all the HB instants. For stability reasons, its
computation is modified~\cite{Weide2005} to take into account
the additional source term,
\begin{equation}
  \label{eq:stabdeltat}
  \Delta\tau_n=\text{CFL}\frac{V}{\|\xi_n\|+\omega NV}.
\end{equation}
The extra term $\omega NV$ is added to the spectral radius $\|\xi_n\|$ to
restrict the time step.  Equation~\eqref{eq:stabdeltat} implies that a
high frequency and/or a high number of harmonics~$N$ can considerably
restrict the time step, especially for explicit Runge Kutta time
integration scheme, as mentioned in~\cite{Hall2002}.

Several implicit schemes, which are theoretically unconditionally stable and thus allow larger
CFL number, have been derived for the HB method: Krylov-space based
methods are used
in~\cite{FLD:FLD2111,woodgate09:_implic_harmon_balan_solver_for}, and
Antheaume~\emph{et
  al.}~\cite{antheaume11:_implic_time_spect_method_for} propose a
point Jacobi algorithm. The present paper uses the block-Jacobi
algorithm derived in Ref.~\cite{Sicot2008} to improve robustness and
efficiency.

This time-domain harmonic balance method has been implemented in the
\emph{elsA} solver~\cite{cambier2012} developed by ONERA and
CERFACS. This code solves the RANS equations using a cell-centered
approach on multi-blocks structured meshes.  Using the HB method,
significant savings in CPU cost have been observed in various
applications such as dynamic derivatives computation~\cite{Hassan2011}
and rotor/stator interactions~\cite{Sicot2012}. It was also extended
to deformable meshes for aeroelasticity
applications~\cite{Dufour2010}.

\subsection{Adaptation to the ALE Formulation}
\label{sec:adapt-ale-form}

The deformation speed $s_D$ is estimated by applying the HB time
derivative operator to the mesh points at all instants:
$s_D^*=D_t(X^*)$. This decomposition is exact when the
  deformation of the mesh has less harmonics than those solved in the
  HB computation~\cite{Dufour2010}. In the present case, the mesh
  deformation follows a purely single frequency law (see
  Eq.~\eqref{eq:6}), therefore all the HB computations will correctly
  estimate the mesh deformation speed regardless of their harmonic content.


\subsubsection{Adaptation to Turbomachinery Single Passage
    Reduction}
\label{sec:Adptatreduction}

The phaselag periodic condition can be derived by applying an
  IDFT on the phase-shifted harmonics ($\widehat{W}_ke^{ik\beta}$) of
  Eq.~????. A linear
combination of all the time instants is obtained:
\begin{equation}
  % \label{eq:16}
  W^*\left(\theta+\phi\frac{2\pi}{B}\right)=\mathcal{E}^{-1}\mathcal{M}\mathcal{E}W^*(\theta),\quad \phi=\pm 1,
\end{equation}
where $\mathcal{M}$ is a diagonal matrix equal to the IBPA modulation
$\mathcal{M}_{k,k}=e^{i k\beta}$. It can be derived
analytically in the same way as the source term Eqs.~ ???
and~ ???:
\begin{equation}
  W\left(x, r, \theta+\phi\frac{2\pi}{B}, t_n\right) =\sum_{m=-N}^N
  b_mW(x, r, \theta, t_{n+m}), 
\end{equation}
%  and can be derived
% analytically in the same way as the source term Eqs.~\eqref{eq:hbtdt} and~\eqref{eq:3}:
% \begin{equation}
%   % \label{eq:16}
%   W^*\left(\theta+\phi\frac{2\pi}{B}\right)=\mathcal{E}^{-1}\mathcal{M}\mathcal{E}W^*(\theta)\
%   \Leftrightarrow\ 
%   W\left(x, r, \theta+\phi\frac{2\pi}{B}, t_n\right) =\sum_{m=-N}^N
%   b_mW(x, r, \theta, t_{n+m}),
% \end{equation}
with
\begin{equation}
  b_m=\frac{1}{2N+1}\left(1+2\sum\nolimits_{k=1}^N\cos\left[k\left(2\pi
        \frac{m}{2N+1}-\phi \beta\right)\right]\right),\quad \phi=\pm 1.
\end{equation}
As the HB method solves and stores simultaneously a uniform sampling
of the time period, it could be considered similar to Erdos' direct
store method. Actually, the method used here is closer to the shape
correction~\cite{He1990}, in a sense that the lag is
computed thanks to Fourier series.%~\cite{Sicot2009}.

\section{Numerical Applications}
For external-flow aeroelasticity, the HB approach has been thoroughly validated~\cite{Gopinath2005,Sicot2008,Woodgate2009,Dufour2010}, mostly for the AGARD test cases of Davis~\cite{Davis1982}. However, experimental data for turbomachinery aeroelasticity are more scarce: the Standard Aeroelastic Configurations experiments of Fransson~\textit{et al.}~\cite{Fransson:1999uq} are the reference in this respect, and have been widely used to validate different numerical approaches~\cite{Sbardella:2001fk,Duta:2002uq,Campobasso:2003fk,Cinnella2004,mcbean2005}. However, this is the first time these results are used to validate HB simulations. %
The presented applications are in increasing complexity.  The first
test case is a turbine stator (STCF~11), for which experimental results are available at both subsonic and transonic conditions.  %The second test case is the
%transonic configuration of the STCF~11. The latter shows non-linear
%effects, such as shock and separation bubble, that helps assessing the
%capability of the HB method to correctly captures such phenomena.
The second test case is an industrial fan configuration, proving the
robustness of the method for industrial requirements.

% section periodic_flows (end)

% chapter harmonic_balance_methods (end)